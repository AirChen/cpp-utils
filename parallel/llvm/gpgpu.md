
SelectionDAGBuilder
负责 IR -> DAG 的转换
不同的基本块 对应不同的 DAG

TargetLowering
执行合法化的原因是SelectionDAGBuilder 模块构造的SDNode 节点中的指令操作数类型和操作不一定能被目标平台支持。
因此， SDNode 节点的合法化涉及操作数类型的合法化和操作的合法化。

目标平台一般不可能为IR 中的所有操作提供指令支持。因此，操作合法化的目的是将这些平
台不支持的操作按三种方式转换成平台支持的操作。
第一，扩展(Expansion) ，即用一组操作来模拟一个操作； 
第二，提升(Promotion) ， 即将数据转换成更大的类型来支持操作；
第三，定制(Custom) ，即通过目标平台相关的钩子程序(hook) 实现合法化


SelectionDAGISel
指令选择是LLVM 后端中的一个重要阶段。这一阶段的输入是经过合法化的SelectionDAG 。从
耗时方面来说， 指令选择占用了后端编译总耗时的一半。指令选择通过节点模式匹配完成DAG 到
DAG 的转换， 将SelectionDAG 节点转换为表示目标指令的节点， 也就是将LLVM IR 指令转换为机
器指令，所以转换后的DAG 又称为machineDAG , 可以用来执行基本块中的运算。


Machinelnstr
指令选择完成后得到以machineDAG 格式表示的基本块， 其内容虽然是机器指令， 但仍然是以
DAG 形式存在。而CPU/GPU 不能执行DAG , 只能执行指令的线性序列。因此， 需要在machineDAG
上进行指令调度，确定基本块中指令的执行顺序，将DAG 节点线性化。
指令调度分为寄存器分配前(pre-RA) 指令调度和寄存器分配后(post-RA) 指令调度。


经过指令选择阶段产生的代码是SSA 形式的，代码中可以使用无限多的虚拟寄存器，而硬件平
台的物理寄存器数量是有限的。如果物理寄存器数量不足以容纳所有虚拟寄存器，虚拟寄存器则会
被溢出(spill ) 到内存。因此，寄存器分配的目的是为虚拟寄存器分配物理寄存器，并优化寄存器
分配过程，使虚拟寄存器的溢出代价最小化。虚拟寄存器到物理寄存器的映射有两种方式： 直接映
射和司接映射。直接映射利用TargetRegisterlnfo 和MachineOperand 类获取加载／保存指令插入位置，
间接映射利用VirtRegMap 类处理加载／保存指令。LLVM 中的寄存器分配算法有四种： 基本寄存器
分配、快速寄存器分配、PBQP 寄存器分配和贪厌寄存器分配。
寄存器分配过程依赖其他分析pass 的分析结果， 其中最重要的是寄存器合并( re护ster coalesce) pass 和虚拟寄存器重写(virtual re伊sterrewrite) pass ，